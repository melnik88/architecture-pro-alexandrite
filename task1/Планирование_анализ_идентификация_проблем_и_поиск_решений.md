
# Планирование: анализ, идентификация проблем и поиск решений

## 1. Анализ текущей архитектуры

### Текущее состояние системы

Система состоит из трёх основных приложений:
- **Онлайн-магазин** (Vue + Java Spring Boot) - B2C канал
- **CRM** (Vue + Java Spring Boot) - управление заказами менеджерами
- **MES** (React + C#) - производственная система

**Инфраструктура:**
- Облачное развёртывание (Yandex Cloud)
- По одному EC2 инстансу на каждое приложение
- PostgreSQL базы данных (managed services) с одним инстансом на запись/чтение
- RabbitMQ для асинхронной коммуникации между системами
- S3-хранилище для 3D-моделей

**Процессы:**
- Двухнедельные спринты
- Ручное тестирование E2E-сценариев
- Ручной деплой в release и prod окружения
- Автоматический деплой в dev после прохождения юнит-тестов

---

## 2. Идентификация проблем

### 2.1 Критические проблемы (требуют немедленного решения)

#### П1. Потеря заказов и сообщений в RabbitMQ
**Симптомы:**
- Клиенты не получают заказы
- Пользователи API жалуются на потерянные заказы
- Заказы "зависают" на месяцы вместо обещанных 3 недель

**Причины:**
- Отсутствие механизмов гарантированной доставки сообщений
- Нет мониторинга очередей и dead letter queues
- Отсутствие retry-механизмов при сбоях
- Нет логирования и трейсинга межсервисной коммуникации

**Влияние:** Потеря крупных контрактов, отток клиентов B2C

#### П2. Проблемы производительности MES
**Симптомы:**
- Долгая загрузка первой страницы MES (дашборд с заказами)
- Фильтры и пагинация не решили проблему
- Операторы не могут быстро взять новые заказы

**Причины:**
- Один инстанс базы данных на чтение и запись
- Отсутствие индексов или неоптимальные запросы
- Нет кэширования часто запрашиваемых данных

**Влияние:** Снижение производительности операторов, задержки в производстве

#### П3. Единая точка отказа (SPOF)
**Симптомы:**
- По одному инстансу каждого приложения
- Один инстанс базы данных

**Причины:**
- Отсутствие горизонтального масштабирования
- Нет load balancer'ов
- Нет репликации баз данных

**Влияние:** Любой сбой приводит к полной недоступности системы

#### П4. Долгий расчёт стоимости (2-30 минут)
**Симптомы:**
- Среднее время расчёта 2-3 минуты
- Сложные модели обрабатываются до 30 минут
- Блокирует пользовательский опыт

**Причины:**
- Синхронная обработка сложных вычислений
- Отсутствие оптимизации алгоритма расчёта
- Нет кэширования результатов для похожих моделей

**Влияние:** Плохой UX, потеря конверсии, перегрузка API

### 2.2 Высокоприоритетные проблемы

#### П5. Отсутствие мониторинга и observability
**Симптомы:**
- Проблемы обнаруживаются только через жалобы клиентов
- Нет понимания, где теряются заказы

**Причины:**
- Отсутствие централизованного логирования
- Нет метрик и алертов
- Отсутствие distributed tracing

**Влияние:** Реактивный подход к проблемам, долгое время восстановления

#### П6. Медленный цикл релизов
**Симптомы:**
- Задержки релизов превышают месяц
- Ручное тестирование E2E-сценариев
- Ручной деплой в release и prod

**Причины:**
- Отсутствие автоматизированного тестирования
- Один QA-инженер на всё ручное тестирование
- Нет CI/CD для автоматического деплоя

**Влияние:** Медленная доставка фиксов и новых фич, накопление технического долга

#### П7. Отсутствие масштабируемости под растущую нагрузку
**Симптомы:**
- Линейный рост заказов (+100/месяц)
- Открытие API для B2B увеличило нагрузку
- Система не справляется с текущей нагрузкой

**Причины:**
- Монолитная архитектура без возможности независимого масштабирования
- Отсутствие rate limiting для API
- Нет автоматического масштабирования

**Влияние:** Деградация производительности, потеря бизнеса

### 2.3 Среднеприоритетные проблемы

#### П8. Отсутствие разделения ответственности
**Симптомы:**
- MES рассчитывает стоимость, но эта логика нужна и в Shop API
- Дублирование данных о заказах в разных системах
- Сложная синхронизация состояния через RabbitMQ

**Причины:**
- Нечёткие границы между доменами
- Отсутствие выделенных сервисов для общей функциональности

**Влияние:** Сложность поддержки, риск рассинхронизации данных

#### П9. Технический долг в интеграциях
**Симптомы:**
- Интеграция MES-CRM через RabbitMQ реализована командой, а не из коробки
- Разные технологические стеки (Java, C#, Vue, React)

**Причины:**
- Покупка MES с исходным кодом без готовой интеграции
- Исторические причины выбора технологий

**Влияние:** Сложность поддержки, требуется знание разных стеков

#### П10. Отсутствие disaster recovery плана
**Симптомы:**
- Нет описанных процедур восстановления
- Нет резервного копирования с проверенным восстановлением

**Причины:**
- Фокус на развитии функциональности, а не на надёжности

**Влияние:** Риск потери данных при сбоях

---

## 3. Список инициатив для устранения проблем

### Инициатива 1: Внедрение надёжной обработки сообщений
**Цель:** Устранить потерю заказов и сообщений

**Задачи:**
- Настроить Dead Letter Queues (DLQ) в RabbitMQ
- Реализовать retry-механизмы с exponential backoff
- Добавить idempotency keys для предотвращения дублирования
- Внедрить transactional outbox pattern для гарантированной доставки
- Создать мониторинг очередей с алертами

**Оценка:** 2 backend разработчика

### Инициатива 2: Внедрение distributed tracing и централизованного логирования
**Цель:** Обеспечить observability системы

**Задачи:**
- Внедрить OpenTelemetry/Jaeger для distributed tracing
- Настроить ELK stack (Elasticsearch, Logstash, Kibana) или аналог
- Добавить correlation ID для всех запросов
- Создать дашборды для мониторинга ключевых метрик
- Настроить алерты на критические события

**Оценка:** DevOps + 1 backend разработчик

### Инициатива 3: Оптимизация производительности MES
**Цель:** Ускорить загрузку дашборда заказов

**Задачи:**
- Провести анализ медленных запросов (query profiling)
- Добавить необходимые индексы в базу данных
- Внедрить Redis для кэширования списков заказов
- Реализовать read replica для базы данных MES
- Добавить пагинацию на уровне БД, а не приложения

**Оценка:** 1 backend C# разработчик + DevOps

### Инициатива 4: Горизонтальное масштабирование приложений
**Цель:** Устранить SPOF и обеспечить масштабируемость

**Задачи:**
- Настроить Application Load Balancer для каждого приложения
- Развернуть минимум 2 инстанса каждого приложения
- Настроить auto-scaling на основе метрик CPU/Memory
- Обеспечить stateless архитектуру приложений
- Вынести сессии в Redis/Memcached

**Оценка:** DevOps + 1 backend разработчик

### Инициатива 5: Асинхронная обработка расчёта стоимости
**Цель:** Улучшить UX и снизить нагрузку на API

**Задачи:**
- Перевести расчёт стоимости на асинхронную обработку через очередь
- Реализовать WebSocket/Server-Sent Events для уведомлений о готовности
- Добавить кэширование результатов расчёта для похожих моделей
- Внедрить rate limiting для API запросов
- Оптимизировать алгоритм расчёта (если возможно)

**Оценка:** 2 backend разработчика (Java + C#)

### Инициатива 6: Автоматизация тестирования
**Цель:** Ускорить цикл релизов

**Задачи:**
- Написать автоматизированные E2E тесты для критических сценариев
- Внедрить integration тесты для API
- Настроить запуск тестов в CI/CD pipeline
- Добавить smoke тесты для prod окружения
- Обучить QA-инженера автоматизации (уже есть прототипы)

**Оценка:** QA инженер + 1 backend разработчик (помощь)

### Инициатива 7: Репликация баз данных
**Цель:** Повысить отказоустойчивость и производительность чтения

**Задачи:**
- Настроить master-slave репликацию для всех PostgreSQL БД
- Разделить read/write операции в приложениях
- Настроить автоматический failover
- Протестировать процедуры восстановления

**Оценка:** DevOps + 1 backend разработчик

### Инициатива 8: Выделение сервиса расчёта стоимости
**Цель:** Разделить ответственность и упростить масштабирование

**Задачи:**
- Создать отдельный микросервис для расчёта стоимости
- Вынести логику расчёта из MES в новый сервис
- Обеспечить API для Shop и внешних пользователей
- Реализовать независимое масштабирование сервиса

**Оценка:** 2 backend разработчика (Java + C#)

### Инициатива 9: Внедрение API Gateway
**Цель:** Централизовать управление API и безопасность

**Задачи:**
- Развернуть API Gateway (Kong, AWS API Gateway, или аналог)
- Настроить rate limiting и throttling
- Реализовать централизованную аутентификацию/авторизацию
- Добавить API versioning
- Настроить мониторинг API метрик

**Оценка:** DevOps + 1 backend разработчик

### Инициатива 10: Disaster Recovery план
**Цель:** Обеспечить восстановление после сбоев

**Задачи:**
- Настроить автоматическое резервное копирование БД
- Протестировать процедуры восстановления
- Документировать runbook для типовых инцидентов
- Настроить backup для S3 хранилища
- Провести disaster recovery drill

**Оценка:** DevOps

### Инициатива 11: Улучшение CI/CD
**Цель:** Автоматизировать деплой и ускорить доставку

**Задачи:**
- Автоматизировать деплой в release окружение после прохождения тестов
- Внедрить blue-green или canary deployment для prod
- Добавить автоматический rollback при сбоях
- Настроить feature flags для постепенного раскатывания фич

**Оценка:** DevOps + тимлид

### Инициатива 12: Оптимизация работы с 3D-моделями
**Цель:** Ускорить обработку и снизить нагрузку

**Задачи:**
- Внедрить CDN для доставки 3D-моделей
- Реализовать предварительную обработку моделей (упрощение полигонов)
- Добавить валидацию моделей на клиенте
- Оптимизировать хранение в S3 (lifecycle policies)

**Оценка:** 1 frontend + 1 backend разработчик

---

## 4. Приоритизация инициатив

### Критерии приоритизации:
1. **Влияние на бизнес** - решает ли критические проблемы с потерей клиентов
2. **Срочность** - насколько быстро нужно решение
3. **Сложность реализации** - время и ресурсы
4. **Зависимости** - блокирует ли другие инициативы
5. **ROI** - соотношение пользы и затрат

### Приоритизированный список:

#### Tier 1 - Критические (0-2 месяца)
1. **Инициатива 2: Distributed tracing и логирование** - без этого невозможно диагностировать проблемы
2. **Инициатива 1: Надёжная обработка сообщений** - решает проблему потери заказов
3. **Инициатива 3: Оптимизация производительности MES** - критично для операторов

#### Tier 2 - Высокий приоритет (2-4 месяца)
4. **Инициатива 4: Горизонтальное масштабирование** - устраняет SPOF
5. **Инициатива 7: Репликация баз данных** - повышает отказоустойчивость
6. **Инициатива 5: Асинхронная обработка расчёта** - улучшает UX

#### Tier 3 - Средний приоритет (4-6 месяцев)
7. **Инициатива 9: API Gateway** - централизует управление API
8. **Инициатива 6: Автоматизация тестирования** - ускоряет релизы
9. **Инициатива 11: Улучшение CI/CD** - автоматизирует деплой

#### Tier 4 - Долгосрочные (6+ месяцев)
10. **Инициатива 8: Выделение сервиса расчёта** - архитектурное улучшение
11. **Инициатива 10: Disaster Recovery план** - важно, но не блокирует текущие проблемы
12. **Инициатива 12: Оптимизация 3D-моделей** - улучшение, но не критично

---

## 5. Целевая архитектура через полгода

### Ключевые изменения:

#### 5.1 Инфраструктура
- **Высокая доступность:**
  - Минимум 2 инстанса каждого приложения за Load Balancer
  - Master-slave репликация всех баз данных
  - Auto-scaling на основе метрик

- **Observability:**
  - Централизованное логирование (ELK stack)
  - Distributed tracing (Jaeger/OpenTelemetry)
  - Мониторинг метрик (Prometheus + Grafana)
  - Алерты на критические события

#### 5.2 Архитектура приложений
- **Надёжная коммуникация:**
  - Dead Letter Queues для всех очередей
  - Retry механизмы с exponential backoff
  - Idempotency для всех операций
  - Transactional outbox pattern

- **API Gateway:**
  - Единая точка входа для всех API
  - Rate limiting и throttling
  - Централизованная аутентификация
  - API versioning

- **Асинхронная обработка:**
  - Расчёт стоимости через очереди
  - WebSocket для real-time уведомлений
  - Кэширование результатов (Redis)

#### 5.3 Процессы разработки
- **Автоматизация:**
  - E2E тесты для критических сценариев
  - Integration тесты в CI/CD
  - Автоматический деплой в release
  - Blue-green deployment в prod

- **Быстрые релизы:**
  - Цикл релиза сокращён до 1-2 недель
  - Автоматический rollback при сбоях
  - Feature flags для постепенного раскатывания

#### 5.4 Производительность
- **Оптимизация MES:**
  - Read replica для чтения
  - Redis кэш для списков заказов
  - Оптимизированные запросы с индексами
  - Загрузка дашборда < 2 секунд

- **Масштабируемость:**
  - Горизонтальное масштабирование всех компонентов
  - Обработка 2x текущей нагрузки без деградации
  - Rate limiting защищает от перегрузки
