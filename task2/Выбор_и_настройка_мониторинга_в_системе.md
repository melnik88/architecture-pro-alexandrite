# Выбор и настройка мониторинга в системе

## Мотивация

### Зачем нужен мониторинг

Компания «Александрит» столкнулась с критическими проблемами, которые напрямую влияют на бизнес:

1. **Потеря крупных контрактов** — после открытия API для B2B-клиентов компания потеряла несколько крупных контрактов из-за проблем с обработкой заказов
2. **Рост недовольства клиентов** — увеличилось количество жалоб на просроченные заказы как от B2C, так и от B2B-клиентов
3. **Проблемы с производительностью** — операторы жалуются на медленную загрузку дашборда MES
4. **Отсутствие видимости** — команда не может быстро обнаружить и локализовать проблемы в системе

### Что даст мониторинг компании

**Для бизнеса:**
- **Снижение оттока клиентов** — быстрое обнаружение и устранение проблем до того, как они повлияют на клиентов
- **Возврат доверия B2B-партнеров** — возможность предоставлять SLA и отслеживать их выполнение
- **Увеличение выручки** — предотвращение потери заказов из-за технических проблем
- **Прогнозирование роста** — понимание, когда нужно масштабировать инфраструктуру

**Для команды разработки:**
- **Быстрая диагностика проблем** — сокращение времени на поиск причин сбоев с часов до минут
- **Проактивное обнаружение** — выявление проблем до того, как о них сообщат пользователи
- **Обоснованные решения** — данные для принятия решений о масштабировании и оптимизации
- **Снижение стресса** — меньше экстренных ситуаций и ночных вызовов

**Финансовое обоснование:**
- Стоимость потери одного крупного контракта >> стоимость внедрения мониторинга
- ROI достигается уже после предотвращения потери 1-2 крупных клиентов
- Экономия времени команды на диагностику проблем (до 70% времени на инциденты)

## Выбор подхода к мониторингу

### Выбранный подход: RED (Rate, Errors, Duration)

Для системы «Александрит» выбран подход **RED (Rate, Errors, Duration)**

1. **Фокус на пользовательском опыте** — RED метрики напрямую отражают качество сервиса с точки зрения пользователя
2. **Простота внедрения** — метрики легко собирать на уровне HTTP-запросов
3. **Универсальность** — подходит для всех трёх API (Shop, CRM, MES)
4. **Быстрая диагностика** — позволяет быстро определить, где именно возникла проблема

**Компоненты RED:**
- **Rate (Частота запросов)** — сколько запросов в секунду обрабатывает сервис
- **Errors (Ошибки)** — процент неуспешных запросов
- **Duration (Длительность)** — время обработки запросов

### Дополнительные метрики

Помимо RED, будут отслеживаться:
- **Метрики инфраструктуры** — для понимания насыщенности ресурсов (CPU, Memory)
- **Метрики очередей RabbitMQ** — критически важны для интеграции между системами
- **Метрики баз данных** — для предотвращения узких мест в хранилище данных

## Выбранные метрики и их описание

### 1. Rate (Частота запросов)

#### 1.1. Number of requests (RPS) for internet shop API
**Зачем нужна:** Отслеживание нагрузки на онлайн-магазин, выявление пиковых нагрузок и планирование масштабирования, корреляция с бизнес-метриками.

**Ярлыки:** endpoint, method, status_code, user_type

#### 1.2. Number of requests (RPS) for CRM API
**Зачем нужна:** Мониторинг активности менеджеров по продажам, выявление проблем с производительностью CRM, планирование масштабирования.

**Ярлыки:** endpoint, method, status_code, user_id

#### 1.3. Number of requests (RPS) for MES API
**Зачем нужна:** Отслеживание нагрузки от операторов производства и внешних B2B-клиентов, выявление аномальной активности.

**Ярлыки:** endpoint, method, status_code, client_type, api_key

#### 1.4. Number of requests (RPS) per user for internet shop API
**Зачем нужна:** Выявление аномального поведения пользователей (атаки, боты), анализ паттернов использования, обнаружение проблем с фронтендом.

**Ярлыки:** user_id, session_id, endpoint

### 2. Errors (Ошибки)

#### 2.1. Number of HTTP 500 for shop API
**Зачем нужна:** Критический индикатор проблем на стороне сервера, прямое влияние на пользовательский опыт и конверсию, основа для алертинга.

**Ярлыки:** endpoint, error_type, method

#### 2.2. Number of HTTP 500 for CRM API
**Зачем нужна:** Обнаружение проблем, блокирующих работу менеджеров, предотвращение потери заказов, мониторинг стабильности интеграций.

**Ярлыки:** endpoint, error_type, method

#### 2.3. Number of HTTP 500 for MES API
**Зачем нужна:** Критично для B2B-клиентов, мониторинг проблем с расчётом стоимости изделий и обработкой 3D-моделей.

**Ярлыки:** endpoint, error_type, method, client_type

#### 2.4-2.6. Number of HTTP 200 for shop/CRM/MES API
**Зачем нужна:** Базовая метрика для расчёта процента ошибок (error rate), мониторинг успешных операций, основа для SLA.

**Ярлыки:** endpoint, method, client_type (для MES)

### 3. Duration (Длительность)

#### 3.1. Response time (latency) for shop API
**Зачем нужна:** Прямое влияние на пользовательский опыт и конверсию, выявление медленных эндпоинтов, мониторинг деградации производительности.

**Ярлыки:** endpoint, method, percentile (p50, p95, p99)

#### 3.2. Response time (latency) for CRM API
**Зачем нужна:** Мониторинг производительности для менеджеров, выявление проблем с загрузкой дашбордов, оптимизация критичных операций.

**Ярлыки:** endpoint, method, percentile

#### 3.3. Response time (latency) for MES API
**Зачем нужна:** Критично для операторов (жалобы на медленную загрузку), мониторинг времени расчёта стоимости изделий (2-30 минут), основа для SLA с B2B-клиентами.

**Ярлыки:** endpoint, method, percentile, model_complexity

### 4. Метрики RabbitMQ (критичны для интеграции)

#### 4.1. Number of dead-letter-exchange letters in RabbitMQ
**Зачем нужна:** Обнаружение потерянных сообщений между системами, прямая причина жалоб на "потерянные заказы", критичный индикатор проблем интеграции.

**Ярлыки:** queue_name, error_reason

#### 4.2. Number of message in flight in RabbitMQ
**Зачем нужна:** Мониторинг задержек в обработке заказов, выявление узких мест в интеграции, предотвращение переполнения очередей.

**Ярлыки:** queue_name, consumer

### 5. Метрики инфраструктуры

#### 5.1-5.3. CPU % for shop/CRM/MES API
**Зачем нужна:** Определение момента для горизонтального масштабирования, выявление неоптимального кода, планирование ресурсов.

**Ярлыки:** instance_id, availability_zone (для shop)

#### 5.4-5.6. Memory Utilisation for shop/CRM/MES API
**Зачем нужна:** Обнаружение утечек памяти, предотвращение OOM ошибок, оптимизация использования ресурсов. Критично для MES из-за обработки больших 3D-моделей.

**Ярлыки:** instance_id

### 6. Метрики баз данных

#### 6.1-6.2. Number of connections for shop/MES db instance
**Зачем нужна:** Предотвращение исчерпания пула соединений, выявление утечек соединений в коде, планирование масштабирования БД.

**Ярлыки:** connection_state, application

#### 6.3-6.4. Memory Utilisation for shop/MES db instance
**Зачем нужна:** Оптимизация кэширования запросов, планирование апгрейда инстанса БД, предотвращение деградации производительности.

**Ярлыки:** memory_type

#### 6.5-6.6. Size of shop/MES db instance
**Зачем нужна:** Планирование расширения хранилища, мониторинг роста данных, оптимизация хранения (архивирование старых заказов).

**Ярлыки:** table_name

### 7. Дополнительные метрики

#### 7.1. Size of S3 storage
**Зачем нужна:** Мониторинг роста хранилища 3D-моделей, планирование бюджета на хранение, оптимизация хранения.

**Ярлыки:** bucket_name, file_type

#### 7.2-7.3. Kb transferred/provided for shop API
**Зачем нужна:** Мониторинг трафика (особенно при загрузке 3D-моделей), оптимизация размера запросов/ответов, планирование сетевых расходов.

**Ярлыки:** endpoint

## План действий

### Этап 1: Подготовка инфраструктуры

**1.1. Развёртывание Prometheus**(devOps)
- Развернуть Prometheus в Yandex Cloud
- Настроить retention policy
- Настроить резервное копирование

**1.2. Развёртывание Grafana**(devOps)
- Развернуть Grafana в Yandex Cloud
- Настроить интеграцию с Prometheus
- Настроить аутентификацию

**1.3. Настройка Alertmanager**(devOps)
- Развернуть Alertmanager
- Настроить интеграцию с Slack/Telegram
- Настроить эскалацию (критичные алерты → звонок дежурному)

### Этап 2: Инструментирование приложений

**2.1. Shop API (Java)** (Java-разработчик)
- Добавить Micrometer + Prometheus registry
- Настроить автоматический сбор HTTP метрик (RED)
- Добавить кастомные метрики и ярлыки
- Создать эндпоинт /actuator/prometheus

**2.2. CRM API (Java)** (Java-разработчик)
- Аналогично Shop API
- Добавить специфичные метрики для CRM

**2.3. MES API (C#)** (C#-разработчик)
- Добавить prometheus-net.AspNetCore
- Настроить автоматический сбор HTTP метрик
- Добавить метрики для расчёта стоимости и дашборда операторов

**2.4. RabbitMQ** (DevOps)
- Установить RabbitMQ Prometheus Plugin
- Настроить scraping метрик очередей и DLQ

### Этап 3: Настройка сбора метрик инфраструктуры

**3.1. EC2 инстансы** (DevOps)
- Установить Node Exporter на все EC2
- Настроить scraping: CPU, Memory, Disk I/O, Network

**3.2. Базы данных** (DevOp)
- Установить PostgreSQL Exporter
- Настроить сбор: connections, query performance, cache hit ratio

**3.3. S3 хранилище** (DevOps)
- Использовать CloudWatch Exporter или Yandex Cloud API
- Собирать: размер хранилища, количество объектов, трафик

### Этап 4: Создание дашбордов

**4.1. Дашборд "RED метрики"** (DevOps + Тимлид)
- Графики Rate, Error Rate, Duration для всех API
- Сравнение метрик между сервисами

**4.2. Дашборд "Интеграции и очереди"** (DevOps)
- Количество сообщений в очередях и DLQ
- Скорость обработки и задержки

**4.3. Дашборд "Инфраструктура"** (DevOps)
- CPU, Memory, Disk для всех инстансов
- Метрики баз данных и S3
- Индикаторы насыщенности

**4.4. Дашборд "Бизнес-метрики"** (DevOps + Продакт-менеджер)
- Количество заказов, конверсия
- Среднее время обработки заказа
- Количество ошибок, влияющих на пользователей

### Этап 5: Настройка алертов

**5.1. Критичные алерты P1** (DevOps + Тимлид)
- Error Rate > 5% (5 мин) → звонок
- API недоступен → звонок
- DLQ > 10 → Slack + звонок
- CPU/Memory > 90% → Slack

**5.2. Важные алерты P2** (DevOp)
- Error Rate > 1% (15 мин) → Slack
- Latency p95 > 2s → Slack
- Queue > 1000 → Slack
- Рост БД > 20%/день → Slack

**5.3. Предупреждающие алерты P3** (DevOps)
- CPU > 70% (1 час) → Slack (планировать масштабирование)
- БД > 80% лимита → Slack (планировать расширение)
- Рост трафика > 50%/неделя → Slack

### Этап 6: Тестирование и документация

**6.1. Тестирование** (QA + DevOps)
- Нагрузочное тестирование для проверки сбора метрик
- Симуляция проблем для проверки алертов
- Проверка эскалации

**6.2. Документация** (Тимлид + DevOps)
- Runbook для реагирования на алерты
- Инструкция по использованию дашбордов
- Документация по добавлению новых метрик

**6.3. Обучение команды** (Тимлид + DevOps)
- Презентация дашбордов для команды разработки
- Обучение реагированию на алерты
- Презентация бизнес-дашборда для продакт-менеджера

## Показатели насыщенности (Saturation)

### 1. CPU Saturation

**Пороговые значения:**
- Warning: CPU > 70% (15 мин)
- Critical: CPU > 85% (5 мин)
- Emergency: CPU > 95% (2 мин)

**Обоснование:** При 70% начинается деградация, при 85% система близка к насыщению, при 95% практически не справляется.

**Действия:**
- **Warning:** Тикет Medium в Jira, уведомление в Slack, планирование оптимизации/масштабирования
- **Critical:** Тикет High, уведомление @devops @team-lead, автоматический запуск дополнительного EC2 через Auto Scaling
- **Emergency:** Инцидент Highest, звонок дежурному, @channel в Slack, немедленное добавление инстансов, включение rate limiting

### 2. Memory Saturation

**Пороговые значения:**
- Warning: Memory > 75% (15 мин)
- Critical: Memory > 85% (5 мин)
- Emergency: Memory > 95% (1 мин)

**Обоснование:** При 75% активное использование swap, при 85% высокий риск OOM killer, при 95% система на грани падения.

**Действия:**
- **Warning:** Тикет Medium, планирование анализа утечек памяти, оптимизации кэширования, увеличения размера инстанса
- **Critical:** Тикет High, запуск дополнительного инстанса, анализ heap dump, перезапуск перегруженного инстанса
- **Emergency:** Инцидент Highest, звонок дежурному, автоматическое добавление инстансов, graceful restart, немедленный анализ причины

### 3. Database Connections Saturation

**Пороговые значения:**
- Warning: Connections > 70% от max_connections
- Critical: Connections > 85% от max_connections
- Emergency: Connections > 95% от max_connections

**Обоснование:** При исчерпании пула приложение не может работать с БД, это критичная проблема, блокирующая все операции.

**Действия:**
- **Warning:** Тикет, планирование аудита использования соединений, поиска утечек, увеличения max_connections, настройки connection pooling
- **Critical:** Тикет High, увеличение max_connections (временная мера), анализ долгоживущих соединений, принудительное закрытие idle соединений
- **Emergency:** Инцидент Highest, звонок дежурному, автоматическое увеличение max_connections до максимума, принудительное закрытие idle соединений (> 5 мин), немедленный поиск утечек, перезапуск приложения

### 4. RabbitMQ Queue Saturation

**Пороговые значения:**
- Warning: Messages > 1000 (10 мин)
- Critical: Messages > 5000 (5 мин)
- Emergency: Messages > 10000 или DLQ > 100

**Обоснование:** Накопление сообщений означает, что консьюмеры не справляются. Это прямая причина задержек в обработке заказов. Сообщения в DLQ — это потерянные заказы.

**Действия:**
- **Warning:** Тикет, планирование оптимизации обработки сообщений, добавления консьюмеров, анализа производительности обработчиков
- **Critical:** Тикет High, запуск дополнительных инстансов консьюмеров, анализ причины медленной обработки, проверка доступности зависимых сервисов
- **Emergency:** Инцидент Highest, звонок дежурному и продакт-менеджеру, автоматическое масштабирование консьюмеров, немедленный анализ DLQ (потерянные заказы!), ручная обработка сообщений из DLQ, уведомление клиентов о задержках, создание компенсационных задач

### 5. Database Storage Saturation

**Пороговые значения:**
- Warning: Storage > 70% от лимита
- Critical: Storage > 85% от лимита
- Emergency: Storage > 95% от лимита

**Обоснование:** При заполнении диска БД перестаёт работать. Managed services автоматически расширяют хранилище, но это стоит денег.

**Действия:**
- **Warning:** Тикет, планирование анализа роста данных, архивирования старых заказов (> 1 года), очистки временных таблиц, расширения хранилища
- **Critical:** Тикет High, планирование расширения хранилища на ближайшее окно обслуживания, начало архивирования данных, анализ таблиц с наибольшим ростом
- **Emergency:** Инцидент Highest, звонок дежурному, автоматическое расширение хранилища (если настроено auto-scaling), немедленное расширение хранилища вручную, экстренная очистка логов и временных данных, архивирование старых данных

### 6. API Response Time Saturation

**Пороговые значения:**
- Warning: p95 latency > 2s (10 мин)
- Critical: p95 latency > 5s (5 мин)
- Emergency: p95 latency > 10s или p50 > 5s

**Обоснование:** Медленные ответы напрямую влияют на пользовательский опыт. Пользователи покидают сайт при задержках > 3 секунд. Это критично для конверсии и удержания клиентов.

**Действия:**
- **Warning:** Тикет, планирование профилирования медленных эндпоинтов, оптимизации запросов к БД, добавления кэширования, масштабирования
- **Critical:** Тикет High, добавление инстансов приложения, анализ медленных запросов в БД, включение дополнительного кэширования, проверка нагрузки на БД
- **Emergency:** Инцидент Highest, звонок дежурному, автоматическое масштабирование приложения, включение rate limiting для защиты, немедленный анализ причины, возможное отключение неприоритетных функций, уведомление пользователей о проблемах

### 7. S3 Storage Saturation

**Пороговые значения:**
- Warning: Storage > 80% от бюджета на месяц
- Critical: Storage > 90% от бюджета
- Emergency: Storage > 95% от бюджета

**Обоснование:** S3 не имеет технических лимитов, но есть бюджетные ограничения. Неконтролируемый рост может привести к значительным расходам.

**Действия:**
- **Warning:** Тикет, уведомление продакт-менеджера, планирование анализа роста хранилища, удаления дубликатов 3D-моделей, настройки lifecycle policies (перенос в Glacier), сжатия файлов
- **Critical:** Тикет High, уведомление продакт-менеджера и финансового отдела, начало переноса старых файлов в Glacier, удаление дубликатов, запрос увеличения бюджета
- **Emergency:** Инцидент, уведомление руководства, экстренная очистка неиспользуемых файлов, немедленный перенос в Glacier, временная блокировка загрузки новых файлов (крайняя мера)
