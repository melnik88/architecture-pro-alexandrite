# Архитектурное решение по логированию

## 1. Анализ системы и определение необходимых логов

### 1.1. Системы для сбора логов

На основе C4-диаграммы и описания архитектуры компании «Александрит», логи необходимо собирать из следующих систем:

1. **Онлайн-магазин** (Vue + Java Spring Boot)
2. **CRM** (Vue + Java Spring Boot)
3. **MES** (React + C#)
4. **RabbitMQ** (брокер сообщений)
5. **Базы данных** (PostgreSQL/MySQL на Yandex Cloud)
6. **API Gateway** (если используется для внешних интеграций)

### 1.2. Список необходимых логов уровня INFO

#### Онлайн-магазин:

| Событие | Поле | Описание |
|---------|------|----------|
| **Создание заказа** | `timestamp` | Время создания |
| | `user_id` | ID пользователя |
| | `order_id` | ID заказа |
| | `status` | `INITIATED` |
| | `client_ip` | IP-адрес клиента |
| **Загрузка 3D-модели** | `timestamp` | Время загрузки |
| | `user_id` | ID пользователя |
| | `order_id` | ID заказа |
| | `file_size_mb` | Размер файла в МБ |
| | `polygon_count` | Количество полигонов |
| | `status` | `FILE_UPLOADED` |
| **Отправка заказа** | `timestamp` | Время отправки |
| | `user_id` | ID пользователя |
| | `order_id` | ID заказа |
| | `status` | `SUBMITTED` |
| | `order_amount` | Сумма заказа (если известна) |
| **API запросы от внешних партнеров** | `timestamp` | Время запроса |
| | `partner_id` | ID партнера |
| | `api_endpoint` | Endpoint API |
| | `http_method` | HTTP метод |
| | `response_status` | Статус ответа |
| | `response_time_ms` | Время обработки в мс |

#### MES:
- **Расчет стоимости**
  - Время начала: `calculation_start_time`
  - Время окончания: `calculation_end_time`
  - Длительность: `calculation_duration_sec`
  - ID заказа: `order_id`
  - Количество полигонов: `polygon_count`
  - Рассчитанная стоимость: `calculated_price`
  - Статус: `PRICE_CALCULATED`

- **Изменение статуса заказа в производстве**
  - Время: `timestamp`
  - ID заказа: `order_id`
  - ID оператора: `operator_id`
  - Предыдущий статус: `previous_status`
  - Новый статус: `new_status` (`MANUFACTURING_STARTED`, `MANUFACTURING_COMPLETED`, `PACKAGING`, `SHIPPED`)

- **Загрузка дашборда операторов**
  - Время: `timestamp`
  - ID оператора: `operator_id`
  - Примененные фильтры: `filters`
  - Количество заказов: `orders_count`
  - Время загрузки: `page_load_time_ms`

#### CRM:

| Событие | Поле | Описание |
|---------|------|----------|
| **Подтверждение заказа** | `timestamp` | Время подтверждения |
| | `order_id` | ID заказа |
| | `manager_id` | ID менеджера |
| | `status` | `MANUFACTURING_APPROVED` |
| **Закрытие заказа** | `timestamp` | Время закрытия |
| | `order_id` | ID заказа |
| | `manager_id` | ID менеджера |
| | `status` | `CLOSED` |
| | `closure_method` | Способ закрытия (автоматически/вручную) |

#### RabbitMQ:

| Событие | Поле | Описание |
|---------|------|----------|
| **Отправка сообщения** | `timestamp` | Время отправки |
| | `queue_name` | Название очереди |
| | `message_id` | ID сообщения |
| | `order_id` | ID заказа |
| | `event_type` | Тип события |
| | `message_size_bytes` | Размер сообщения в байтах |
| **Получение сообщения** | `timestamp` | Время получения |
| | `queue_name` | Название очереди |
| | `message_id` | ID сообщения |
| | `order_id` | ID заказа |
| | `queue_time_ms` | Время в очереди в мс |
| | `processing_status` | Статус обработки |

#### Базы данных:
- **Медленные запросы**
  - Время: `timestamp`
  - База данных: `database_name`
  - Запрос: `query` (параметризованный)
  - Время выполнения: `execution_time_ms`
  - Количество строк: `rows_affected`

### 1.3. Другие уровни логирования

#### DEBUG
Используется в dev и release окружениях для детальной отладки:
- Детальная информация о параметрах запросов
- Промежуточные результаты вычислений
- Состояние объектов перед/после операций
- Трассировка выполнения алгоритмов

**Не используется в production** из-за большого объема данных и возможности утечки чувствительной информации.

#### WARN
Используется для потенциальных проблем, не критичных для работы:
- Превышение порога времени обработки (например, расчет стоимости > 5 минут)
- Повторные попытки отправки сообщений в RabbitMQ
- Приближение к лимитам (дисковое пространство, память, соединения с БД)
- Использование deprecated API
- Неоптимальные запросы к БД (N+1 проблема)

#### ERROR
Используется для ошибок, требующих внимания:
- Ошибки обработки заказов
- Неудачные попытки отправки/получения сообщений из RabbitMQ
- Ошибки подключения к БД
- Ошибки валидации данных
- Исключения в бизнес-логике
- Ошибки интеграции с внешними API

#### FATAL/CRITICAL
Используется для критических ошибок, требующих немедленного вмешательства:
- Недоступность базы данных
- Недоступность RabbitMQ
- Критические ошибки, приводящие к остановке сервиса
- Исчерпание критических ресурсов (память, диск)
- Потеря данных

---

## 2. Мотивация

### 2.1. Зачем нужно логирование

Внедрение централизованного логирования критически важно для компании «Александрит» по следующим причинам:

1. **Ускорение диагностики проблем**: Сейчас разбор инцидентов занимает много времени, так как информация собирается со слов клиентов. Централизованное логирование позволит быстро найти причину проблемы по ID заказа или временной метке.

2. **Снижение нагрузки на поддержку**: Технические специалисты смогут самостоятельно анализировать проблемы без необходимости многократного общения с клиентами.

3. **Проактивное выявление проблем**: Возможность обнаружить проблемы до того, как о них сообщат клиенты (например, рост времени обработки заказов, ошибки интеграции).

4. **Соответствие SLA**: Возможность отслеживать и доказывать выполнение обязательств перед B2B-клиентами.

5. **Оптимизация производительности**: Выявление узких мест в системе (медленные запросы, долгие расчеты стоимости).

6. **Безопасность**: Обнаружение подозрительной активности (DDoS-атаки, попытки несанкционированного доступа).

### 2.2. Технические метрики

1. **MTTR (Mean Time To Resolution)** - среднее время решения проблемы
   - Текущее состояние: 4-8 часов (по оценке)
   - Целевое значение: 30-60 минут
   - Улучшение: 80-90%

2. **MTTD (Mean Time To Detection)** - среднее время обнаружения проблемы
   - Текущее состояние: проблемы обнаруживаются только после жалоб клиентов (часы/дни)
   - Целевое значение: 1-5 минут (с алертингом)
   - Улучшение: проактивное обнаружение

3. **Процент успешной обработки заказов**
   - Текущее состояние: неизвестен (нет метрик)
   - Целевое значение: >99.5%
   - Возможность отслеживания: да

4. **Время обработки API-запросов (p95, p99)**
   - Текущее состояние: неизвестно
   - Целевое значение: p95 < 3 сек, p99 < 5 сек
   - Возможность отслеживания: да

5. **Количество ошибок интеграции с RabbitMQ**
   - Текущее состояние: неизвестно
   - Целевое значение: < 0.1% от всех сообщений
   - Возможность отслеживания: да

### 2.3. Бизнес-метрики

1. **Customer Satisfaction (CSAT)** - удовлетворенность клиентов
   - Текущее состояние: снижается из-за проблем с заказами
   - Ожидаемое улучшение: +15-20% за счет быстрого решения проблем

2. **Retention Rate B2B-клиентов**
   - Текущее состояние: компания теряет крупные контракты
   - Ожидаемое улучшение: сохранение 90%+ контрактов

3. **Стоимость поддержки на один заказ**
   - Текущее состояние: высокая (много времени на разбор проблем)
   - Ожидаемое снижение: 40-50%

4. **Время обработки заказа (end-to-end)**
   - Текущее состояние: часто превышает обещанные 3 недели
   - Ожидаемое улучшение: соблюдение SLA в 95%+ случаев

5. **Revenue от B2B-канала**
   - Текущее состояние: под угрозой из-за проблем с API
   - Ожидаемое улучшение: стабилизация и рост на 30-50%

### 2.4. Приоритизация систем для внедрения

**Первая очередь (критичные системы):**

1. **MES (Manufacturing Execution System)**
   - **Приоритет: ВЫСОКИЙ**
   - **Обоснование**:
     - Здесь происходит расчет стоимости (2-30 минут)
     - Операторы жалуются на медленную загрузку дашборда
     - Критично для отслеживания статусов заказов в производстве
     - Влияет на оба канала продаж (B2C и B2B)

2. **RabbitMQ (интеграционная шина)**
   - **Приоритет: ВЫСОКИЙ**
   - **Обоснование**:
     - Критичная точка интеграции между системами
     - Потеря сообщений = потеря заказов
     - Необходимо отслеживать задержки и ошибки доставки
     - Влияет на все бизнес-процессы

3. **API Gateway / Онлайн-магазин (API для B2B)**
   - **Приоритет: ВЫСОКИЙ**
   - **Обоснование**:
     - Новый канал продаж, приносящий значительную выручку
     - Жалобы от B2B-клиентов на потерянные заказы
     - Необходимо отслеживать доступность и производительность API
     - Риск потери крупных контрактов

**Вторая очередь:**

4. **CRM**
   - **Приоритет: СРЕДНИЙ**
   - **Обоснование**:
     - Важна для отслеживания работы менеджеров
     - Меньше жалоб по сравнению с MES
     - Можно внедрить после стабилизации критичных систем

5. **Онлайн-магазин (B2C)**
   - **Приоритет: СРЕДНИЙ**
   - **Обоснование**:
     - Важен для пользовательского опыта
     - Но проблемы в основном связаны с MES и интеграцией
     - Можно внедрить параллельно с CRM

**Третья очередь:**

6. **Базы данных**
   - **Приоритет: НИЗКИЙ (но важный)**
   - **Обоснование**:
     - Логирование медленных запросов важно для оптимизации
     - Но не является первопричиной текущих проблем
     - Можно внедрить после основных систем


---

## 3. Предлагаемое решение

### 3.1. Архитектура системы логирования

Предлагается внедрить централизованную систему логирования на базе **ELK Stack** (Elasticsearch, Logstash, Kibana) с использованием **Filebeat** для сбора логов.

#### Компоненты решения:

1. **Filebeat** (на каждом сервере приложений)
   - Легковесный агент для сбора логов
   - Отправка логов в Logstash
   - Минимальное влияние на производительность приложений

2. **Logstash** (централизованный сервер обработки)
   - Парсинг и обогащение логов
   - Фильтрация и трансформация данных
   - Маршрутизация в Elasticsearch

3. **Elasticsearch** (хранилище логов)
   - Индексирование и хранение логов
   - Быстрый поиск по логам
   - Агрегация данных

4. **Kibana** (визуализация и анализ)
   - Дашборды для мониторинга
   - Поиск и анализ логов
   - Создание алертов

5. **ElastAlert** (алертинг)
   - Мониторинг аномалий
   - Отправка уведомлений в Slack/Email/PagerDuty
   - Настраиваемые правила алертинга

### 3.2. Технологический стек

#### Для Java Spring Boot приложений (Онлайн-магазин, CRM):
- **Logback** с **Logstash Encoder**
- Формат логов: JSON
- Структурированное логирование с MDC (Mapped Diagnostic Context)

#### Для C# приложения (MES):
- **Serilog** с **Serilog.Sinks.Elasticsearch**
- Формат логов: JSON
- Структурированное логирование

#### Для RabbitMQ:
- Встроенное логирование RabbitMQ
- Filebeat для сбора логов из файлов
- Плагин для мониторинга очередей

### 3.3. Формат логов

Все логи должны быть в формате JSON со следующими обязательными полями:

```json
{
  "timestamp": "2024-01-15T10:30:45.123Z",
  "level": "INFO",
  "application": "MES",
  "environment": "production",
  "host": "mes-prod-01",
  "logger": "OrderService",
  "message": "Order status changed",
  "order_id": "ORD-12345",
  "user_id": "USR-67890",
  "trace_id": "abc123def456",
  "span_id": "span789",
  "previous_status": "SUBMITTED",
  "new_status": "PRICE_CALCULATED",
  "duration_ms": 125000,
  "thread": "http-nio-8080-exec-5"
}
```

## 4. Политика безопасности

### 4.1. Работа с чувствительными данными

#### Категории чувствительных данных:
1. **PII (Personally Identifiable Information)**:
   - ФИО клиентов
   - Адреса доставки
   - Номера телефонов
   - Email-адреса
   - Платежные данные

2. **Бизнес-критичная информация**:
   - Детали ценообразования
   - Коммерческие условия с партнерами
   - Внутренние бизнес-метрики

#### Меры защиты:

1. **Маскирование данных (Data Masking)**:
   - Email: `user@example.com` → `u***@example.com`
   - Телефон: `+7 (999) 123-45-67` → `+7 (***) ***-**-67`
   - ФИО: `Иванов Иван Иванович` → `И***в И. И.`
   - Адрес: частичное маскирование

2. **Исключение из логов**:
   - Пароли (никогда не логируются)
   - Токены аутентификации
   - Полные номера банковских карт
   - CVV коды

3. **Шифрование**:
   - Логи передаются по TLS между компонентами
   - Логи в Elasticsearch хранятся с шифрованием at-rest
   - Резервные копии логов шифруются

### 4.2. Контроль доступа

#### Роли и права доступа:

1. **Администраторы (DevOps, Архитектор)**:
   - Полный доступ ко всем логам
   - Управление конфигурацией ELK
   - Создание и изменение дашбордов
   - Настройка алертов

2. **Разработчики**:
   - Чтение логов своих приложений (dev, release окружения)
   - Ограниченный доступ к production логам (только для своих сервисов)
   - Создание временных дашбордов

3. **QA-инженеры**:
   - Чтение логов в dev и release окружениях
   - Доступ к логам тестовых прогонов

4. **Поддержка (Support)**:
   - Чтение логов по конкретным заказам (по order_id)
   - Ограниченный доступ к production логам
   - Только уровни INFO, WARN, ERROR (без DEBUG)

5. **Менеджеры продукта**:
   - Доступ к агрегированным метрикам через дашборды
   - Без доступа к детальным логам

#### Реализация в Kibana:
- Использование **Kibana Spaces** для разделения окружений
- **Role-Based Access Control (RBAC)** для управления доступом
- Интеграция с корпоративным LDAP/Active Directory
- Аудит доступа к логам (кто, когда, что смотрел)

### 4.3. Compliance и регуляторные требования

1. **GDPR (если есть клиенты из ЕС)**:
   - Право на удаление данных (right to be forgotten)
   - Минимизация хранения PII
   - Документирование обработки персональных данных

2. **152-ФЗ (Российское законодательство)**:
   - Хранение персональных данных на территории РФ
   - Защита персональных данных

3. **PCI DSS (если обрабатываются платежи)**:
   - Запрет на логирование полных номеров карт
   - Защищенное хранение логов
   - Регулярный аудит доступа

---

## 5. Политика хранения логов

### 5.1. Структура индексов

Для каждой системы создается отдельный индекс с ротацией по дням:

1. **Онлайн-магазин**: `shop-logs-YYYY.MM.DD`
2. **CRM**: `crm-logs-YYYY.MM.DD`
3. **MES**: `mes-logs-YYYY.MM.DD`
4. **RabbitMQ**: `rabbitmq-logs-YYYY.MM.DD`
5. **API Gateway**: `api-logs-YYYY.MM.DD`

Преимущества такой структуры:
- Легкое удаление старых данных (удаление индекса целиком)
- Изоляция данных разных систем
- Оптимизация производительности поиска
- Гибкое управление retention policy

### 5.2. Сроки хранения

#### Production окружение:

| Уровень логов | Hot Storage (SSD) | Warm Storage (HDD) | Cold Storage (S3) | Итого |
|---------------|-------------------|--------------------|--------------------|-------|
| ERROR, FATAL  | 30 дней           | 90 дней            | 1 год              | 13 месяцев |
| WARN          | 14 дней           | 60 дней            | 6 месяцев          | 8 месяцев |
| INFO          | 7 дней            | 30 дней            | 3 месяца           | 4.5 месяца |
| DEBUG         | Не используется   | -                  | -                  | - |

#### Dev/Release окружения:
- Все уровни: 7 дней в Hot Storage
- Без архивирования в Warm/Cold Storage

---

## 6. Система анализа логов

### 6.1. Алертинг

#### Критичные алерты (немедленное реагирование):

1. **Недоступность сервиса**
   - Условие: отсутствие логов от сервиса > 2 минут
   - Канал: PagerDuty + SMS
   - Получатели: DevOps on-call, Тимлид

2. **Критические ошибки (FATAL)**
   - Условие: появление логов уровня FATAL
   - Канал: PagerDuty + Slack (#critical-alerts)
   - Получатели: DevOps on-call, Разработчики

3. **Потеря сообщений в RabbitMQ**
   - Условие: ошибки отправки/получения сообщений > 5 за 5 минут
   - Канал: PagerDuty + Slack (#critical-alerts)
   - Получатели: DevOps on-call, Backend-разработчики

4. **Недоступность базы данных**
   - Условие: ошибки подключения к БД > 10 за 1 минуту
   - Канал: PagerDuty + Slack (#critical-alerts)
   - Получатели: DevOps on-call, DBA

#### Важные алерты (реагирование в течение 15-30 минут):

5. **Высокий уровень ошибок (ERROR)**
   - Условие: > 50 ошибок за 5 минут в одном сервисе
   - Канал: Slack (#alerts)
   - Получатели: Разработчики соответствующего сервиса

6. **Медленная обработка заказов**
   - Условие: расчет стоимости > 10 минут для > 5 заказов за час
   - Канал: Slack (#alerts)
   - Получатели: Backend-разработчики, Продакт-менеджер

7. **Медленная загрузка дашборда MES**
   - Условие: время загрузки > 5 секунд для > 10 запросов за 10 минут
   - Канал: Slack (#alerts)
   - Получатели: Backend-разработчики (C#), DBA

8. **Задержки в RabbitMQ**
   - Условие: время в очереди > 30 секунд для > 10 сообщений за 5 минут
   - Канал: Slack (#alerts)
   - Получатели: Backend-разработчики, DevOps

#### Предупреждающие алерты (мониторинг):

9. **Предупреждения (WARN)**
   - Условие: > 100 предупреждений за 10 минут
   - Канал: Slack (#monitoring)
   - Получатели: Разработчики

10. **Приближение к лимитам ресурсов**
    - Условие: использование диска > 80%, памяти > 85%
    - Канал: Slack (#monitoring)
    - Получатели: DevOps

### 6.2. Поиск аномалий

#### Типы аномалий для мониторинга:

1. **Аномальный рост количества заказов**
   - **Описание**: Резкий скачок создания заказов (возможная DDoS-атака)
   - **Метрика**: Количество заказов со статусом INITIATED
   - **Baseline**: Средняя за последние 7 дней
   - **Порог**: Превышение baseline в 10+ раз за 1 минуту
   - **Действие**:
     - Алерт в Slack (#security)
     - Автоматическое включение rate limiting
     - Анализ IP-адресов источников

2. **Аномальное количество ошибок**
   - **Описание**: Резкий рост ошибок в системе
   - **Метрика**: Количество ERROR логов
   - **Baseline**: Средняя за последние 24 часа
   - **Порог**: Превышение baseline в 5+ раз за 5 минут
   - **Действие**: Алерт разработчикам для расследования

3. **Аномальное время обработки**
   - **Описание**: Необычно долгая обработка запросов
   - **Метрика**: p95 время ответа API
   - **Baseline**: Средняя за последние 24 часа
   - **Порог**: Превышение baseline в 3+ раза
   - **Действие**: Алерт для проверки производительности

4. **Аномальное количество неуспешных попыток аутентификации**
   - **Описание**: Возможная попытка взлома
   - **Метрика**: Количество неуспешных логинов
   - **Baseline**: Средняя за последние 7 дней
   - **Порог**: Превышение baseline в 5+ раз
   - **Действие**:
     - Алерт в Slack (#security)
     - Временная блокировка IP при > 10 попытках за минуту

5. **Аномальное количество потерянных сообщений**
   - **Описание**: Проблемы с RabbitMQ или интеграцией
   - **Метрика**: Количество неудачных отправок в RabbitMQ
   - **Baseline**: < 0.1% от всех сообщений
   - **Порог**: > 1% неудачных отправок за 5 минут
   - **Действие**: Критический алерт DevOps

#### Инструменты для обнаружения аномалий:

1. **Elasticsearch Machine Learning**
   - Автоматическое обучение на исторических данных
   - Обнаружение аномалий в реальном времени
   - Настройка для каждой метрики

2. **ElastAlert с правилами**
   - Spike detection (резкий рост)
   - Flatline detection (отсутствие активности)
   - Frequency detection (частота событий)
   - Change detection (изменение паттернов)

### 6.3. Дашборды для мониторинга

#### Дашборд 1: Обзор системы (System Overview)
- Общее количество логов по уровням (INFO, WARN, ERROR, FATAL)
- Количество логов по приложениям
- Top 10 ошибок за последний час
- Доступность сервисов (uptime)
- Активные алерты

**Аудитория**: DevOps, Тимлид, Продакт-менеджер

#### Дашборд 2: Производительность (Performance)
- Время обработки API-запросов (p50, p95, p99)
- Время расчета стоимости в MES
- Время загрузки дашборда операторов
- Медленные запросы к БД (> 1 сек)
- Задержки в RabbitMQ

**Аудитория**: Backend-разработчики, DevOps, DBA

#### Дашборд 3: Бизнес-метрики (Business Metrics)
- Количество заказов по статусам
- Конверсия по воронке заказов
- Среднее время обработки заказа (end-to-end)
- Количество API-запросов от партнеров
- Процент успешных заказов

**Аудитория**: Продакт-менеджер, Менеджеры по продажам

#### Дашборд 4: Интеграции (Integrations)
- Статистика RabbitMQ (отправлено/получено/ошибки)
- Задержки в очередях
- Потерянные сообщения
- Статус интеграций с внешними API

**Аудитория**: Backend-разработчики, DevOps

#### Дашборд 5: Безопасность (Security)
- Неуспешные попытки аутентификации
- Подозрительная активность (аномалии)
- Доступ к чувствительным данным
- Изменения в критичных данных

**Аудитория**: DevOps, Архитектор, Безопасность (если есть)

#### Дашборд 6: Поддержка (Support)
- Поиск по order_id
- История заказа (все события)
- Ошибки по конкретному заказу
- Время обработки на каждом этапе

**Аудитория**: Поддержка, Менеджеры по продажам

### 6.4. Процесс реагирования на инциденты

1. **Обнаружение** (Detection)
   - Автоматический алерт от ElastAlert
   - Или обнаружение через дашборды
   - Или жалоба клиента

2. **Оценка** (Assessment)
   - Проверка дашбордов для понимания масштаба
   - Поиск связанных ошибок в логах
   - Определение затронутых систем

3. **Диагностика** (Diagnosis)
   - Анализ логов по trace_id или order_id
   - Проверка метрик производительности
   - Корреляция событий между системами

4. **Решение** (Resolution)
   - Применение исправления
   - Мониторинг результата через логи
   - Подтверждение решения проблемы

5. **Постмортем** (Post-mortem)
   - Документирование инцидента
   - Анализ первопричины (Root Cause Analysis)
   - Создание задач на улучшение

---

## 7. Дополнительное задание: Сравнение технологий

### 7.1. Критерии выбора

| Критерий | ELK Stack | OpenSearch | Splunk | Grafana Loki | Graylog |
|----------|-----------|------------|--------|--------------|---------|
| **Лицензия** | Elastic License 2.0 (ограничения) | Apache License 2.0 (открытая) | Проприетарная | Apache License 2.0 | Open Source (SSPL) |
| **Стоимость** | Бесплатно (базовая), платные фичи от $95/мес | Бесплатно (полностью) | От $150/GB/год | Бесплатно | Бесплатно (базовая), Enterprise от $3000/год |
| **Масштабируемость** | Отлично (горизонтальное масштабирование) | Отлично (форк Elasticsearch) | Отлично | Хорошо (оптимизирован для меток) | Хорошо |
| **Производительность поиска** | Очень высокая (полнотекстовый поиск) | Очень высокая (аналогично ES) | Очень высокая | Средняя (оптимизирован для метрик) | Высокая |
| **Простота настройки** | Средняя (требует опыта) | Средняя | Простая (GUI) | Простая | Простая (веб-интерфейс) |
| **Визуализация** | Kibana (мощная) | OpenSearch Dashboards | Отличная (встроенная) | Grafana (отличная) | Встроенная (хорошая) |
| **Алертинг** | ElastAlert или X-Pack (платно) | Встроенный | Встроенный (мощный) | Grafana Alerting | Встроенный |
| **Интеграции** | Множество (Logstash, Beats) | Множество (совместимо с ES) | Множество | Promtail, Fluentd | Множество |
| **Требования к ресурсам** | Высокие (Java, много RAM) | Высокие (аналогично ES) | Очень высокие | Низкие (эффективное хранение) | Средние |
| **Поддержка структурированных логов** | Отлично (JSON native) | Отлично | Отлично | Хорошо (через метки) | Отлично |
| **Machine Learning** | Да (X-Pack, платно) | Да (встроенный) | Да (встроенный) | Нет | Ограниченно |
| **Сообщество и документация** | Очень большое | Растущее | Большое (коммерческое) | Растущее | Среднее |
| **Облачные решения** | Elastic Cloud | AWS OpenSearch Service | Splunk Cloud | Grafana Cloud | Graylog Cloud |
| **Поддержка Kubernetes** | Отлично (ECK оператор) | Отлично | Хорошо | Отлично (нативная интеграция) | Хорошо |
| **Retention и архивирование** | ILM (Index Lifecycle Management) | ISM (Index State Management) | Встроенное | Встроенное | Встроенное |

### 7.2. Обоснование выбора ELK Stack

#### Преимущества для компании «Александрит»:

1. **Зрелость и надежность**
   - Проверенное решение с большим сообществом
   - Множество готовых интеграций
   - Обширная документация и примеры

2. **Мощный поиск**
   - Полнотекстовый поиск по всем полям
   - Агрегации для аналитики
   - Быстрый поиск по order_id, user_id и другим полям

3. **Гибкость**
   - Logstash для сложной обработки логов
   - Filebeat для легковесного сбора
   - Множество плагинов

4. **Визуализация**
   - Kibana предоставляет мощные дашборды
   - Легко создавать кастомные визуализации
   - Удобный интерфейс для поддержки

5. **Масштабируемость**
   - Горизонтальное масштабирование
   - Подходит для роста компании (100 заказов/месяц)

#### Недостатки и риски:

1. **Лицензия**
   - Elastic License 2.0 имеет ограничения
   - Некоторые фичи платные (ML, алертинг в X-Pack)
   - **Митигация**: Использовать OpenSearch как альтернативу или ElastAlert для алертинга

2. **Требования к ресурсам**
   - Требует много RAM (минимум 4GB на узел)
   - **Митигация**: Использовать managed service (Yandex Cloud Elasticsearch)

3. **Сложность настройки**
   - Требует опыта для оптимальной настройки
   - **Митигация**: Обучение DevOps-инженера, использование готовых конфигураций

#### Альтернативный вариант: OpenSearch

Если лицензионные ограничения Elastic станут проблемой, **OpenSearch** является отличной альтернативой:
- Полностью открытая лицензия (Apache 2.0)
- Совместимость с большинством инструментов Elastic
- Встроенный алертинг и ML
- Поддержка AWS (OpenSearch Service)
